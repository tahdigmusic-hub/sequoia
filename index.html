<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sequo√Øa ‚Äì Pay via Venmo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(180deg, #020617, #0f172a);
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 28px 16px;
    }

    .container{ width: 100%; max-width: 1040px; }

    /* ---------- TOP BAR ---------- */
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:14px; margin-bottom:16px; flex-wrap:wrap;
    }
    .brand{ min-width:220px; flex:1 1 280px; }
    .brand h1{
      font-size:44px; letter-spacing:-0.03em; font-weight:860;
      line-height:1.05; margin-bottom:6px;
    }
    .sub{ opacity:.82; font-size:14px; line-height:1.35; }

    /* ---------- ADMIN BUTTON ---------- */
    .adminBtn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px; border-radius:999px;
      border:1px solid rgba(239,68,68,0.65);
      background:rgba(239,68,68,0.95);
      color:#fff; cursor:pointer; user-select:none; white-space:nowrap;
      max-width:100%; flex:0 0 auto;
      transition:transform .15s ease, opacity .2s ease;
    }
    .adminBtn:active{ transform:scale(0.98); }
    .adminBtn .lockIcon{ font-size:16px; transform:translateY(-0.5px); }
    .adminBtn .btnText{
      font-weight:900; font-size:14px; max-width:220px;
      overflow:hidden; text-overflow:ellipsis;
    }
    .lockPill{
      font-size:11px; opacity:.9; padding:4px 9px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.28);
      background:rgba(255,255,255,0.14);
    }
    @media (max-width:420px){
      .adminBtn{ width:100%; justify-content:space-between; }
      .adminBtn .btnText{ max-width:none; font-size:13px; }
    }

    /* ---------- ADMIN PANEL ---------- */
    .adminPanel{
      display:none; margin:14px 0 18px; padding:14px;
      border-radius:18px; background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      backdrop-filter:blur(8px);
      box-shadow:0 10px 30px rgba(0,0,0,0.22);
    }
    .adminPanelHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:10px; flex-wrap:wrap;
    }
    .adminTitle{ font-weight:850; font-size:14px; margin-bottom:4px; }
    .adminHint{ font-size:12px; opacity:.75; line-height:1.35; max-width:820px; }

    .toggleRow{
      display:grid; grid-template-columns:1fr auto;
      gap:10px; padding:10px; border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      margin-top:10px; align-items:center;
    }
    .toggleLabel{ font-size:13px; opacity:.9; line-height:1.3; }
    .switchWrap{ display:inline-flex; align-items:center; gap:10px; font-size:12px; opacity:.85; }
    input[type="checkbox"]{ width:18px; height:18px; accent-color:#3b82f6; cursor:pointer; }

    .adminRight{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .smallBtn{
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.06);
      color:#fff; cursor:pointer; font-size:12px;
      transition:transform .15s ease, background .2s ease;
    }
    .smallBtn:hover{ background:rgba(255,255,255,0.10); }
    .smallBtn:active{ transform:scale(0.98); }

    /* limit/counter UI inside admin */
    .metaLine{
      margin-top:6px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
      font-size:12px;
      opacity:.9;
    }
    .pill{
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.06);
      white-space:nowrap;
    }
    .limitInput{
      width:84px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(2,6,23,0.35);
      color:#fff;
      outline:none;
      font-size:12px;
    }
    .limitInput::placeholder{ color:rgba(255,255,255,0.45); }

    /* ---------- CARDS GRID ---------- */
    .grid{ display:grid; grid-template-columns:1fr; gap:14px; margin-top:8px; }
    @media (min-width:760px){ .grid{ grid-template-columns:1fr 1fr 1fr; } }
    @media (min-width:1020px){ .grid{ grid-template-columns:repeat(5, 1fr); } }

    .card{
      position:relative;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:18px;
      padding:16px;
      backdrop-filter:blur(8px);
      box-shadow:0 10px 30px rgba(0,0,0,0.22);
      display:flex; flex-direction:column; gap:10px;
      min-height:320px;
    }
    .price{ font-size:20px; font-weight:900; letter-spacing:-0.02em; line-height:1.15; }
    .desc{ opacity:.92; font-size:13px; line-height:1.35; }
    .divider{ height:1px; background:rgba(255,255,255,0.10); margin:2px 0 6px; }

    /* ---------- PAY BUTTON ---------- */
    .btn{
      position:relative; display:inline-block; width:100%;
      padding:14px; border-radius:999px;
      border:2px solid rgba(59,130,246,1);
      color:#fff; text-decoration:none; text-align:center;
      font-weight:800; letter-spacing:0.01em;
      overflow:hidden; background:transparent; cursor:pointer;
      user-select:none; margin-top:auto;
      transition:transform .15s ease, border-color .2s ease, opacity .2s ease;
    }
    .btn::before{
      content:""; position:absolute; left:0; top:0; height:100%; width:0%;
      background:rgba(59,130,246,1); z-index:-1; transition:width .25s ease;
    }
    .btn:hover::before{ width:100%; }
    .btn:active{ transform:scale(0.98); }
    .btn.green{ border-color:rgba(16,185,129,1); } .btn.green::before{ background:rgba(16,185,129,1); }
    .btn.amber{ border-color:rgba(245,158,11,1); } .btn.amber::before{ background:rgba(245,158,11,1); }
    .btn.purple{ border-color:rgba(168,85,247,1); } .btn.purple::before{ background:rgba(168,85,247,1); }
    .btn.rose{ border-color:rgba(244,63,94,1); } .btn.rose::before{ background:rgba(244,63,94,1); }

    .tiny{ opacity:.65; font-size:12px; margin-top:6px; }

    .optPhoto{
      width:100%; height:140px; object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.06);
      margin-top:10px;
    }

    /* ---------- SOLD OUT ---------- */
    .soldOut{ opacity:0.55; filter:grayscale(0.35); }
    .soldOut .btn{
      pointer-events:none; cursor:not-allowed;
      border-color:rgba(148,163,184,0.8);
    }
    .soldOut .btn::before{ background:rgba(148,163,184,0.6); }

    .soldOutStamp{
      position:absolute; inset:0; display:none;
      align-items:center; justify-content:center;
      pointer-events:none;
    }
    .soldOut .soldOutStamp{ display:flex; }
    .soldOutStamp span{
      transform:rotate(-18deg);
      font-weight:900; letter-spacing:0.18em; font-size:26px;
      color:rgba(239,68,68,0.50);
      border:3px solid rgba(239,68,68,0.45);
      padding:10px 14px; border-radius:10px;
      text-transform:uppercase;
      background:rgba(15,23,42,0.15);
      box-shadow:0 12px 30px rgba(0,0,0,0.28);
    }

    /* ---------- QR SECTION ---------- */
    .qrWrap{
      margin-top:22px; padding:16px; border-radius:18px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      backdrop-filter:blur(8px);
      box-shadow:0 10px 30px rgba(0,0,0,0.22);
      display:grid; gap:12px; justify-items:center; text-align:center;
    }
    .qrTitle{ font-weight:900; font-size:18px; opacity:.95; }
    .qrSub{ font-size:13px; opacity:.75; line-height:1.35; max-width:760px; }

    .flow{ width:100%; display:grid; grid-template-columns:1fr; gap:10px; margin-top:6px; }
    @media (min-width:760px){ .flow{ grid-template-columns:repeat(5,1fr); } }

    .step{
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.05);
      border-radius:14px; padding:12px 10px;
      min-height:78px;
      display:grid; gap:6px; align-content:center;
    }
    .step .n{ font-weight:900; letter-spacing:0.06em; opacity:.9; font-size:12px; }
    .step .t{ font-size:13px; opacity:.9; line-height:1.25; }

    .qrImg{
      width:min(320px, 90vw);
      height:auto;
      border-radius:16px;
      background:rgba(255,255,255,0.92);
      padding:10px;
    }

    .note{ margin-top:14px; text-align:center; opacity:.7; font-size:13px; line-height:1.35; }

    /* ---------- TOAST ---------- */
    .toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      z-index:9999; width:min(560px, calc(100vw - 24px));
      background:rgba(2,6,23,0.92);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:16px; padding:12px 14px;
      box-shadow:0 14px 40px rgba(0,0,0,0.45);
      display:none; gap:8px; align-items:flex-start;
    }
    .toast.show{ display:flex; animation:pop 0.18s ease-out; }
    @keyframes pop{
      from { transform:translateX(-50%) translateY(10px); opacity:0; }
      to   { transform:translateX(-50%) translateY(0); opacity:1; }
    }
    .toast .icon{ font-size:18px; margin-top:2px; }
    .toast .msg{ text-align:left; font-size:13px; line-height:1.35; opacity:.95; }
    .toast .close{
      margin-left:auto; border:0; background:transparent;
      color:rgba(255,255,255,0.8); cursor:pointer; font-size:18px;
      line-height:1; padding:2px 6px;
    }

    /* ---------- WELCOME MODAL ---------- */
    .welcomeOverlay{
      position:fixed; inset:0;
      background:rgba(2,6,23,0.55);
      backdrop-filter:blur(6px);
      display:none; align-items:center; justify-content:center;
      z-index:10000; padding:18px;
    }
    .welcomeOverlay.show{ display:flex; }
    .welcomeCard{
      width:min(520px, 92vw);
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:22px;
      padding:18px 18px 14px;
      box-shadow:0 18px 60px rgba(0,0,0,0.55);
      text-align:center;
      animation:shakeIn 0.55s ease-out;
    }
    @keyframes shakeIn{
      0%   { transform:scale(0.92) translateY(8px); opacity:0; }
      55%  { transform:scale(1.02) translateY(0); opacity:1; }
      70%  { transform:translateX(-6px); }
      80%  { transform:translateX(6px); }
      90%  { transform:translateX(-3px); }
      100% { transform:translateX(0); }
    }
    .welcomeTitle{ font-weight:900; letter-spacing:-0.02em; font-size:18px; margin-bottom:8px; }
    .welcomeMsg{ opacity:.88; font-size:14px; line-height:1.45; }
    .welcomeBtn{
      margin-top:14px; width:100%;
      padding:12px 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.08);
      color:#fff; cursor:pointer; font-weight:800;
    }
    .welcomeBtn:active{ transform:scale(0.98); }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <h1>üå≤ Sequo√Øa</h1>
        <div class="sub">
          Choose an option and pay Aaron on Venmo.<br />
          Venmo note will be prefilled as: <strong>‚ÄúCamping sequoia‚Äù</strong>
        </div>
      </div>

      <button id="adminBtn" class="adminBtn" type="button" aria-label="Sina backdoor access">
        <span class="lockIcon">üîí</span>
        <span class="btnText">Sina‚Äôs backdoor access</span>
        <span id="lockPill" class="lockPill">Locked</span>
      </button>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="adminPanel" aria-hidden="true">
      <div class="adminPanelHeader">
        <div>
          <div class="adminTitle">Admin Controls</div>
          <div class="adminHint">
            Click limits + SOLD OUT are global now (Supabase). Set an optional <strong>click limit</strong> (auto SOLD OUT when reached), or toggle availability manually.
          </div>
        </div>
        <div class="adminRight">
          <button id="refreshBtn" class="smallBtn" type="button">Refresh</button>
          <button id="lockBtn" class="smallBtn" type="button">Lock</button>
        </div>
      </div>

      <!-- Party Yurt -->
      <div class="toggleRow">
        <div class="toggleLabel"><strong>$299</strong> ‚Äî Party Yurt</div>
        <label class="switchWrap">Available <input id="toggle299" type="checkbox" /></label>
        <div class="metaLine" style="grid-column: 1 / -1;">
          <span class="pill">Clicks: <strong id="count299">0</strong></span>
          <span class="pill">Limit:</span>
          <input id="limit299" class="limitInput" type="number" min="0" step="1" placeholder="‚àû" />
        </div>
      </div>

      <!-- Lovers Yurt -->
      <div class="toggleRow">
        <div class="toggleLabel"><strong>$449</strong> ‚Äî Lovers Yurt</div>
        <label class="switchWrap">Available <input id="toggle449" type="checkbox" /></label>
        <div class="metaLine" style="grid-column: 1 / -1;">
          <span class="pill">Clicks: <strong id="count449">0</strong></span>
          <span class="pill">Limit:</span>
          <input id="limit449" class="limitInput" type="number" min="0" step="1" placeholder="‚àû" />
        </div>
      </div>

      <!-- Cabins -->
      <div class="toggleRow">
        <div class="toggleLabel"><strong>$499</strong> ‚Äî Cabins</div>
        <label class="switchWrap">Available <input id="toggle499" type="checkbox" /></label>
        <div class="metaLine" style="grid-column: 1 / -1;">
          <span class="pill">Clicks: <strong id="count499">0</strong></span>
          <span class="pill">Limit:</span>
          <input id="limit499" class="limitInput" type="number" min="0" step="1" placeholder="‚àû" />
        </div>
      </div>

      <!-- Friends hut -->
      <div class="toggleRow">
        <div class="toggleLabel"><strong>$349</strong> ‚Äî Friends' hut</div>
        <label class="switchWrap">Available <input id="toggle349" type="checkbox" /></label>
        <div class="metaLine" style="grid-column: 1 / -1;">
          <span class="pill">Clicks: <strong id="count349">0</strong></span>
          <span class="pill">Limit:</span>
          <input id="limit349" class="limitInput" type="number" min="0" step="1" placeholder="‚àû" />
        </div>
      </div>

      <!-- Van lifers -->
      <div class="toggleRow">
        <div class="toggleLabel"><strong>$300</strong> ‚Äî Van lifers</div>
        <label class="switchWrap">Available <input id="toggle300" type="checkbox" /></label>
        <div class="metaLine" style="grid-column: 1 / -1;">
          <span class="pill">Clicks: <strong id="count300">0</strong></span>
          <span class="pill">Limit:</span>
          <input id="limit300" class="limitInput" type="number" min="0" step="1" placeholder="‚àû" />
        </div>
      </div>
    </div>

    <!-- Cards -->
    <div class="grid">
      <!-- 299 Party Yurt -->
      <div id="card299" class="card" data-key="a299">
        <div class="soldOutStamp"><span>SOLD OUT</span></div>
        <div class="price" id="title299">$299: Party Yurt</div>
        <div class="divider"></div>
        <div class="desc" id="sub299">4 people capacity, üõå 1 queen, 2 twin beds</div>

        <a id="pay299" class="btn" href="#" role="button">Pay $299 on Venmo</a>
        <img class="optPhoto" id="img299" src="yurt4.png" alt="Party Yurt photo (4 people)" />
        <div class="tiny">@aaron_levy</div>
      </div>

      <!-- 449 Lovers Yurt -->
      <div id="card449" class="card" data-key="a449">
        <div class="soldOutStamp"><span>SOLD OUT</span></div>
        <div class="price" id="title449">$449: Lovers Yurt</div>
        <div class="divider"></div>
        <div class="desc" id="sub449">2 people capacity, üõå 1 queen bed</div>

        <a id="pay449" class="btn green" href="#" role="button">Pay $449 on Venmo</a>
        <img class="optPhoto" id="img449" src="yurt2.png" alt="Lovers Yurt photo (2 people)" />
        <div class="tiny">@aaron_levy</div>
      </div>

      <!-- 499 Cabins -->
      <div id="card499" class="card" data-key="a499">
        <div class="soldOutStamp"><span>SOLD OUT</span></div>
        <div class="price" id="title499">$499: Cabins</div>
        <div class="divider"></div>
        <div class="desc" id="sub499">2 to 8 people per cabin, üõå queen beds</div>

        <a id="pay499" class="btn amber" href="#" role="button">Pay $499 on Venmo</a>
        <img class="optPhoto" id="img499" src="cabin.png" alt="Cabin photo" />
        <div class="tiny">@aaron_levy</div>
      </div>

      <!-- 349 Friends' hut -->
      <div id="card349" class="card" data-key="a349">
        <div class="soldOutStamp"><span>SOLD OUT</span></div>
        <div class="price" id="title349">$349: Friends' hut</div>
        <div class="divider"></div>
        <div class="desc" id="sub349">2 people capacity, üõå 2 twin beds</div>

        <a id="pay349" class="btn purple" href="#" role="button">Pay $349 on Venmo</a>
        <img class="optPhoto" id="img349" src="bunk.png" alt="Bunk / Friends hut photo" />
        <div class="tiny">@aaron_levy</div>
      </div>

      <!-- 300 Van lifers -->
      <div id="card300" class="card" data-key="a300">
        <div class="soldOutStamp"><span>SOLD OUT</span></div>
        <div class="price" id="title300">$300: Van lifers</div>
        <div class="divider"></div>
        <div class="desc" id="sub300">BYO camper van ‚Äî No hookups</div>

        <a id="pay300" class="btn rose" href="#" role="button">Pay $300 on Venmo</a>
        <img class="optPhoto" id="img300" src="van.png" alt="Camper van photo" />
        <div class="tiny">@aaron_levy</div>
      </div>
    </div>

    <!-- QR backup -->
    <div class="qrWrap">
      <div class="qrTitle">‚ÄºÔ∏è If Venmo does not open, use the QR code to pay ‚ÄºÔ∏è</div>
      <div class="qrSub">Follow this quick flow (works best on iPhone & Android):</div>

      <div class="flow" aria-label="QR payment steps">
        <div class="step"><div class="n">STEP 1</div><div class="t">Press & hold the QR image üì∑</div></div>
        <div class="step"><div class="n">STEP 2</div><div class="t">Tap ‚ÄúSave to Photos‚Äù ‚úÖ</div></div>
        <div class="step"><div class="n">STEP 3</div><div class="t">Open Venmo üíô</div></div>
        <div class="step"><div class="n">STEP 4</div><div class="t">Tap the Image button üñºÔ∏è</div></div>
        <div class="step"><div class="n">STEP 5</div><div class="t">Select saved QR ‚ûú Pay</div></div>
      </div>

      <img class="qrImg" alt="Venmo QR code for @aaron_levy" src="aaronvenmo.png" />

      <div class="note">
        Don‚Äôt forget: note should say <strong>Camping sequoia</strong> and choose the correct amount.
      </div>
    </div>

    <div class="note">
      Tip: Some in-app browsers (Instagram/TikTok/Facebook) block Venmo app opens ‚Äî QR is the most reliable backup.
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <div class="icon">üö´</div>
    <div id="toastMsg" class="msg"></div>
    <button class="close" type="button" aria-label="Close" onclick="hideToast()">√ó</button>
  </div>

  <!-- Welcome modal -->
  <div id="welcomeOverlay" class="welcomeOverlay" role="dialog" aria-modal="true">
    <div class="welcomeCard">
      <div class="welcomeTitle">We‚Äôre glad you are here ‚ó°Ãà</div>
      <div class="welcomeMsg">All prices is per person.</div>
      <button class="welcomeBtn" type="button" onclick="closeWelcome()">Let‚Äôs go</button>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const ADMIN_PASSWORD = "Seq123";
    const ADMIN_TOKEN_STORAGE_KEY = "sequoia_admin_token_v1";
    const NOTE_TEXT = "Camping sequoia";
    const RECIPIENT = "aaron_levy";
    const POLL_MS = 8000;

    const ID_MAP = {
      a299: { card: "card299", pay: "pay299", title: "title299", sub: "sub299", img: "img299", toggle: "toggle299", count: "count299", limit: "limit299" },
      a449: { card: "card449", pay: "pay449", title: "title449", sub: "sub449", img: "img449", toggle: "toggle449", count: "count449", limit: "limit449" },
      a499: { card: "card499", pay: "pay499", title: "title499", sub: "sub499", img: "img499", toggle: "toggle499", count: "count499", limit: "limit499" },
      a349: { card: "card349", pay: "pay349", title: "title349", sub: "sub349", img: "img349", toggle: "toggle349", count: "count349", limit: "limit349" },
      a300: { card: "card300", pay: "pay300", title: "title300", sub: "sub300", img: "img300", toggle: "toggle300", count: "count300", limit: "limit300" },
    };

    const labels = {
      a299: "$299: Party Yurt",
      a449: "$449: Lovers Yurt",
      a499: "$499: Cabins",
      a349: "$349: Friends' hut",
      a300: "$300: Van lifers",
    };

    // =========================
    // WELCOME MODAL
    // =========================
    function closeWelcome(){
      document.getElementById("welcomeOverlay").classList.remove("show");
    }
    window.closeWelcome = closeWelcome;

    window.addEventListener("load", () => {
      document.getElementById("welcomeOverlay").classList.add("show");
    });

    // =========================
    // TOAST
    // =========================
    let toastTimer = null;
    function showToast(message) {
      const toast = document.getElementById("toast");
      document.getElementById("toastMsg").textContent = message;
      toast.classList.add("show");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(hideToast, 3800);
    }
    function hideToast() {
      document.getElementById("toast").classList.remove("show");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = null;
    }
    window.hideToast = hideToast;

    // =========================
    // VENMO LINK + FALLBACK
    // =========================
    function venmoDeepLink(amount){
      const note = encodeURIComponent(NOTE_TEXT);
      return `venmo://paycharge?txn=pay&recipients=${encodeURIComponent(RECIPIENT)}&amount=${encodeURIComponent(amount)}&note=${note}`;
    }
    function venmoWebFallback(amount){
      const note = encodeURIComponent(NOTE_TEXT);
      return `https://venmo.com/${encodeURIComponent(RECIPIENT)}?txn=pay&amount=${encodeURIComponent(amount)}&note=${note}`;
    }

    function openVenmo(amount){
      // attempt deep link
      window.location.href = venmoDeepLink(amount);
      // fallback to web after a short delay
      setTimeout(() => {
        window.location.href = venmoWebFallback(amount);
      }, 800);
    }

    // =========================
    // BACKEND HELPERS
    // =========================
    async function apiGetState(){
      const res = await fetch("/.netlify/functions/get-state", { cache: "no-store" });
      const json = await res.json();
      if (!res.ok) throw new Error(json?.error || "Failed to load state");
      return json;
    }

    async function apiClick(id){
      const res = await fetch("/.netlify/functions/click", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ id })
      });
      const json = await res.json();
      if (!res.ok) throw new Error(json?.error || "Click failed");
      return json; // {ok, soldOut}
    }

    async function apiAdminUpdate({ id, available, click_limit }){
      const token = localStorage.getItem(ADMIN_TOKEN_STORAGE_KEY) || "";
      if (!token) throw new Error("Missing admin token");

      const res = await fetch("/.netlify/functions/admin-update", {
        method: "POST",
        headers: {
          "content-type": "application/json",
          "x-admin-token": token
        },
        body: JSON.stringify({ id, available, click_limit })
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json?.error || "Admin update failed");
      return json;
    }

    // =========================
    // UI APPLY
    // =========================
    function setCardSoldOut(cardEl, soldOut){
      if (soldOut) cardEl.classList.add("soldOut");
      else cardEl.classList.remove("soldOut");
    }

    function applyOptionRow(opt){
      // opt: {id,title,subtitle,amount,image,available,click_limit,clicks}
      const map = ID_MAP[opt.id];
      if (!map) return;

      const card = document.getElementById(map.card);
      const pay = document.getElementById(map.pay);
      const title = document.getElementById(map.title);
      const sub = document.getElementById(map.sub);
      const img = document.getElementById(map.img);

      // text
      if (title) title.textContent = opt.title || labels[opt.id] || "";
      if (sub) sub.textContent = opt.subtitle || "";
      if (img && opt.image) img.src = opt.image;

      // sold out state: available=false => sold out
      setCardSoldOut(card, !opt.available);

      // button label + click handler
      const amount = opt.amount;
      pay.textContent = `Pay $${amount} on Venmo`;
      pay.href = venmoDeepLink(amount); // helps some browsers
      pay.onclick = async (e) => {
        e.preventDefault();

        // if sold out, block immediately
        if (!opt.available || card.classList.contains("soldOut")){
          showToast(`The ${labels[opt.id]} option is sold out. Please choose from remaining options.`);
          return false;
        }

        try{
          const result = await apiClick(opt.id);
          // refresh state right after click so UI updates everywhere
          await refreshFromBackend({ toastSoldOutForId: result?.soldOut ? opt.id : null });

          if (result?.soldOut){
            showToast(`The ${labels[opt.id]} option is sold out. Please choose from remaining options.`);
            return false;
          }

          // open venmo
          openVenmo(amount);
          return true;
        }catch(err){
          showToast(err?.message || "Something went wrong. Try the QR code below.");
          return false;
        }
      };
    }

    function applyAdminRow(opt){
      const map = ID_MAP[opt.id];
      if (!map) return;

      const toggle = document.getElementById(map.toggle);
      const count = document.getElementById(map.count);
      const limit = document.getElementById(map.limit);

      if (toggle) toggle.checked = !!opt.available;
      if (count) count.textContent = String(opt.clicks ?? 0);
      if (limit) limit.value = (opt.click_limit === null || typeof opt.click_limit === "undefined") ? "" : String(opt.click_limit);
    }

    let lastOptionsById = {};

    async function refreshFromBackend({ toastSoldOutForId = null } = {}){
      const data = await apiGetState();
      const options = data?.options || [];

      const byId = {};
      for (const opt of options) byId[opt.id] = opt;

      // apply all UI
      for (const opt of options){
        applyOptionRow(opt);
        applyAdminRow(opt);

        // sold-out toast only on transitions, or if requested
        const prev = lastOptionsById[opt.id];
        if (prev && prev.available && !opt.available){
          showToast(`The ${labels[opt.id]} option is sold out. Please choose from remaining options.`);
        }
      }

      lastOptionsById = byId;

      // if we want a toast for a specific id (after click)
      if (toastSoldOutForId && byId[toastSoldOutForId] && !byId[toastSoldOutForId].available){
        showToast(`The ${labels[toastSoldOutForId]} option is sold out. Please choose from remaining options.`);
      }
    }

    // =========================
    // ADMIN LOCK/UNLOCK
    // =========================
    const els = {
      adminBtn: document.getElementById("adminBtn"),
      adminPanel: document.getElementById("adminPanel"),
      lockPill: document.getElementById("lockPill"),
      lockBtn: document.getElementById("lockBtn"),
      refreshBtn: document.getElementById("refreshBtn"),
    };

    const LOCK_KEY = "sequoia_admin_unlocked_v9";

    function setLockedUI(isUnlocked){
      if (isUnlocked){
        els.adminPanel.style.display = "block";
        els.adminPanel.setAttribute("aria-hidden", "false");
        els.lockPill.textContent = "Unlocked";
      }else{
        els.adminPanel.style.display = "none";
        els.adminPanel.setAttribute("aria-hidden", "true");
        els.lockPill.textContent = "Locked";
      }
    }

    function getUnlocked(){ return localStorage.getItem(LOCK_KEY) === "true"; }
    function setUnlocked(val){
      localStorage.setItem(LOCK_KEY, val ? "true" : "false");
      setLockedUI(val);
    }

    function ensureAdminToken(){
      const existing = localStorage.getItem(ADMIN_TOKEN_STORAGE_KEY);
      if (existing) return true;

      const token = prompt("Paste your Netlify ADMIN_TOKEN (Site config ‚Üí Environment variables):");
      if (!token) return false;
      localStorage.setItem(ADMIN_TOKEN_STORAGE_KEY, token.trim());
      return true;
    }

    els.adminBtn.addEventListener("click", async () => {
      if (getUnlocked()){
        // toggle panel open/close
        const isHidden = els.adminPanel.style.display === "none";
        els.adminPanel.style.display = isHidden ? "block" : "none";
        els.adminPanel.setAttribute("aria-hidden", isHidden ? "false" : "true");
        return;
      }

      const pw = prompt("Enter password for Sina‚Äôs backdoor access:");
      if (pw !== ADMIN_PASSWORD){
        if (pw !== null) showToast("Wrong password.");
        return;
      }

      // optional: capture admin token once so server updates can work
      if (!ensureAdminToken()){
        showToast("Admin token not set. Admin changes won‚Äôt save yet.");
      }

      setUnlocked(true);
      try{ await refreshFromBackend(); }catch(e){}
    });

    els.lockBtn.addEventListener("click", () => setUnlocked(false));
    els.refreshBtn.addEventListener("click", async () => {
      try{ await refreshFromBackend(); }
      catch(e){ showToast(e?.message || "Refresh failed"); }
    });

    // bind admin controls to backend updates
    function bindAdminControls(id){
      const map = ID_MAP[id];
      const toggle = document.getElementById(map.toggle);
      const limit = document.getElementById(map.limit);

      if (toggle){
        toggle.addEventListener("change", async () => {
          try{
            if (!ensureAdminToken()) throw new Error("Admin token not set");
            await apiAdminUpdate({ id, available: toggle.checked, click_limit: undefined });
            await refreshFromBackend();
          }catch(e){
            showToast(e?.message || "Admin update failed");
            // revert toggle to last known state
            const prev = lastOptionsById[id];
            if (prev) toggle.checked = !!prev.available;
          }
        });
      }

      if (limit){
        let t = null;
        limit.addEventListener("input", () => {
          // debounce to avoid spamming the function while typing
          if (t) clearTimeout(t);
          t = setTimeout(async () => {
            try{
              if (!ensureAdminToken()) throw new Error("Admin token not set");

              const raw = limit.value.trim();
              const click_limit = raw === "" ? null : Math.max(0, Math.floor(Number(raw)));

              if (raw !== "" && !Number.isFinite(click_limit)) throw new Error("Limit must be a number");

              // keep availability as-is (server will auto-sold-out on clicks)
              await apiAdminUpdate({ id, available: undefined, click_limit });
              await refreshFromBackend();
            }catch(e){
              showToast(e?.message || "Limit update failed");
              // revert to last known
              const prev = lastOptionsById[id];
              if (prev) limit.value = (prev.click_limit === null || typeof prev.click_limit === "undefined") ? "" : String(prev.click_limit);
            }
          }, 450);
        });
      }
    }

    for (const id of Object.keys(ID_MAP)) bindAdminControls(id);

    // init
    setLockedUI(getUnlocked());

    (async function init(){
      try{
        await refreshFromBackend();
      }catch(e){
        showToast("Could not load live availability. Try refreshing, or use the QR code below.");
      }

      // poll so other users see updates without refreshing
      setInterval(async () => {
        try{ await refreshFromBackend(); }catch(e){}
      }, POLL_MS);
    })();
  </script>
</body>
</html>
